var model=EQ.namespace("eQ.MetricChart");codemr.metricchart=function(t,e,r,a){var c={myMetricSpec:e,myMetricValues:r};metricToolTipId=t+"-tooltip",a&&(d3.select("#"+t).append("div").attr("id",metricToolTipId),metricToolTipId="#"+metricToolTipId,d3.select(metricToolTipId).classed("metric-chart-tooltip",!0),d3.select(metricToolTipId).classed("metric-chart-tooltip-hidden",!0)),model.BARWITHDIV=25,model.chartMargin={top:20,right:20,bottom:20,left:40},model.chartWidth=560-model.chartMargin.left-model.chartMargin.right,model.chartHeight=240-model.chartMargin.top-model.chartMargin.bottom;var l=d3.scale.ordinal().rangeRoundPoints([0,model.chartWidth]),o=d3.scale.linear().range([0,model.chartWidth]),i=d3.scale.linear().range([model.chartHeight,0]),n=["#007F24","#62BF18","#FFC800","#FF5B13","#E50000"],d=["Low","Low-medium","Medium-high","High","Very high"],s=d3.svg.axis().scale(l).orient("bottom"),m=d3.svg.axis().scale(d3.scale.linear().range([model.chartHeight,0])).orient("left");svg=d3.select("#"+t).append("svg").attr("width",model.chartWidth+model.chartMargin.left+model.chartMargin.right).attr("height",model.chartHeight+model.chartMargin.top+model.chartMargin.bottom).append("g").attr("transform","translate("+model.chartMargin.left+","+model.chartMargin.top+")"),nameElement=d3.select("#"+t).append("text").attr("class","default-text-color").html("");for(var h={},p=0;p<c.myMetricValues.length;++p)h[c.myMetricValues[p].name]=+c.myMetricValues[p].value;var u=[""];Array.prototype.push.apply(u,c.myMetricSpec.map((function(t){return t.shortname}))),u.push(" "),l.domain(u),rectWidth=Math.floor(o.range()[1]/model.BARWITHDIV),rectHeight=Math.min(3,Math.floor(i.range()[0]/100)),rectCorner=rectHeight/2,yD=model.chartHeight-rectHeight-rectHeight;var g=[],y=[];for(p=0;p<c.myMetricSpec.length;++p){y.push({spec:c.myMetricSpec[p]}),i.domain([c.myMetricSpec[p].thresholds[0],c.myMetricSpec[p].thresholds[5]]);var M=[i(c.myMetricSpec[p].thresholds[1]),i(c.myMetricSpec[p].thresholds[2]),i(c.myMetricSpec[p].thresholds[3]),i(c.myMetricSpec[p].thresholds[4])];for(c.myMetricSpec[p].level=0;h[c.myMetricValues[p].name]>c.myMetricSpec[p].thresholds[c.myMetricSpec[p].level]&&c.myMetricSpec[p].level<c.myMetricSpec[p].thresholds.length;)c.myMetricSpec[p].level++;c.myMetricSpec[p].level=c.myMetricSpec[p].level-1;for(var f=0;yD>0;){for(;yD<M[f]&&f<M.length;)f++;g.push({metricLevel:f,posY:yD,spec:c.myMetricSpec[p]}),yD-=3*rectHeight}yD=model.chartHeight-rectHeight-rectHeight}svg.append("rect").attr("x",-model.chartMargin.left).attr("y",-model.chartMargin.top).attr("width","100%").attr("height","100%").attr("rx",5).attr("ry",5).attr("fill","black"),svg.append("g").attr("transform","translate("+model.chartMargin.left+","+model.chartMargin.top+")");var v=svg.append("g").attr("class","valuetextContainer");v.selectAll(".valuetext").data(c.myMetricSpec).enter().append("text").attr("class","valuetext").attr("x",(function(t){return l(t.shortname)-rectWidth/2})).attr("y",-3).attr("text-anchor","middle").text((function(t){return h[t.name]})),svg.append("g").attr("class","scatrect").attr("class","x axis").attr("transform","translate(0,"+model.chartHeight+")").call(s).append("text").attr("class","label").attr("x",model.chartWidth).attr("y",-6).style("text-anchor","end").text("Metric"),svg.append("g").attr("class","y axis").call(m).append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Metric Value");var x=svg.append("g").attr("class","fakeColumnContainer"),T=svg.append("g").attr("class","dotContainer");x.selectAll(".dot").data(g).enter().append("rect").attr("class","dot").attr("width",model.BARWITHDIV+6).attr("height",model.chartHeight-rectHeight).attr("stroke-width",0).attr("stroke-opacity",0).attr("fill-opacity",0).attr("x",(function(t){return l(t.spec.shortname)-model.BARWITHDIV/2-3})).attr("y",0).on("mousemove",(function(t){return I(t)})).on("mouseout",(function(t){return H(t)})).style("fill",(function(t){return"white"})),T.selectAll(".dot").data(g).enter().append("rect").attr("class","dot").attr("width",rectWidth).attr("height",rectHeight).attr("stroke-width",0).attr("stroke-opacity",1).attr("rx",rectCorner).attr("ry",rectCorner).attr("x",(function(t){return l(t.spec.shortname)-rectWidth/2})).attr("y",(function(t){return t.posY})).attr("opacity",(function(t){return i.domain([t.spec.thresholds[0],t.spec.thresholds[5]]),i(h[t.spec.name])>t.posY?.2:1})).on("mousemove",(function(t){return I(t)})).on("mouseout",(function(t){return H(t)})).style("fill",(function(t){return n[t.metricLevel]}));var S=svg.selectAll(".legend").data(d).enter().append("g").attr("class","legend").attr("transform",(function(t,e){return"translate(0,"+20*(5-e)+")"}));S.append("rect").attr("x",model.chartWidth-18).attr("width",18).attr("height",9).attr("rx",2*rectCorner).attr("ry",2*rectCorner).style("fill",(function(t,e){return n[e]})),S.append("text").attr("x",model.chartWidth-24).attr("y",9).style("text-anchor","end").text((function(t){return t}));var I=function(e){if(a){var r=d3.event.pageX,c=d3.event.pageY;elem=document.getElementById(t),boundingRect=elem.getBoundingClientRect();var l=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;d3.event.pageX>boundingRect.left+boundingRect.width/2?(d3.select(metricToolTipId).style("right",l-r+"px"),d3.select(metricToolTipId).style("left","auto"),d3.select(metricToolTipId).style("top",c+"px")):(d3.select(metricToolTipId).style("left",r+"px"),d3.select(metricToolTipId).style("right","auto"),d3.select(metricToolTipId).style("top",c+"px")),d3.select(metricToolTipId).html("<strong>"+e.spec.name+":</strong> <span style='color:red'>"+h[e.spec.name]+"<br>("+d[e.spec.level]+")<br></span>"),d3.select(metricToolTipId).classed("metric-chart-tooltip-hidden",!1)}},H=function(t){a&&d3.select(metricToolTipId).classed("metric-chart-tooltip-hidden",!0)};return model.updateDotsFunctionMap||(model.updateDotsFunctionMap={}),model.updateDots||(model.updateDots=function(t,e){for(var r in model.updateDotsFunctionMap)model.updateDotsFunctionMap[r].updateMetricValues(t,e)}),metricChartManager={},metricChartManager.updateMetricValues=function(t,e){for(var r=0;r<t.length;++r)h[t[r].name]=+t[r].value;for(r=0;r<c.myMetricSpec.length;++r){for(c.myMetricSpec[r].level=0;h[c.myMetricValues[r].name]>c.myMetricSpec[r].thresholds[c.myMetricSpec[r].level]&&c.myMetricSpec[r].level<c.myMetricSpec[r].thresholds.length;)c.myMetricSpec[r].level++;c.myMetricSpec[r].level=c.myMetricSpec[r].level-1,c.myMetricSpec[r].level>=5&&(c.myMetricSpec[r].level=4),c.myMetricSpec[r].level<=0&&(c.myMetricSpec[r].level=0),e&&nameElement.html("<br>"+e)}T.selectAll(".dot").attr("opacity",(function(t){return i.domain([t.spec.thresholds[0],t.spec.thresholds[5]]),i(h[t.spec.name])>t.posY?.2:1})),v.selectAll(".valuetext").text((function(t){return h[t.name]}))},model.updateDotsFunctionMap[t]=metricChartManager,model.handleMBCheckBox=function(e){e.checked?document.getElementById(t).style.display="inline":document.getElementById(t).style.display="none"},metricChartManager.setVisible=function(e){e?d3.select("#"+t).classed("metric-chart-hidden",!1):d3.select("#"+t).classed("metric-chart-hidden",!0)},metricChartManager.getWidth=function(){return 560},metricChartManager};
